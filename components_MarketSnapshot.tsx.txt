import React from 'react';
import { MarketSnapshotData } from '../types';
import { PieChart, Pie, Cell, ResponsiveContainer } from 'recharts';

interface Props {
  data: MarketSnapshotData;
  reportRef: React.RefObject<HTMLDivElement | null>;
}

const Logo = () => (
  <div className="bg-orange-600 p-2.5 rounded-xl shadow-lg ring-4 ring-orange-600/10">
    <svg width="42" height="42" viewBox="0 0 500 500" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M250 450C250 450 400 380 400 150V100H100V150C100 380 250 450 250 450Z" fill="white"/>
      <path d="M150 280C180 275 220 260 250 200C260 180 270 170 300 170C330 170 345 185 370 195C350 190 330 185 310 185C280 185 270 195 260 215C230 280 180 300 130 305L150 280Z" fill="#ea580c"/>
    </svg>
  </div>
);

const MarketSnapshotReport: React.FC<Props> = ({ data, reportRef }) => {
  const adData = [
    { name: 'Advances', value: data.advanceDecline.advances, color: '#10b981' },
    { name: 'Declines', value: data.advanceDecline.declines, color: '#ef4444' }
  ];

  const currentTime = new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });

  return (
    <div 
      ref={reportRef}
      className="w-[800px] bg-white overflow-hidden relative flex flex-col border border-slate-200"
      style={{ minHeight: '1200px' }}
    >
      {/* Header section with Dynamic Brand Identity */}
      <div className="bg-[#0f172a] text-white p-10 relative overflow-hidden">
        <div className="absolute top-0 right-0 w-96 h-96 bg-orange-600/5 rounded-full -mr-48 -mt-48 blur-[80px]"></div>
        <div className="absolute bottom-0 left-0 w-48 h-1 bg-orange-600"></div>
        <div className="relative flex justify-between items-end">
            <div className="flex items-center gap-6">
                <Logo />
                <div>
                    <h1 className="text-4xl font-black uppercase tracking-tighter leading-none mb-2 italic">Vivek Financial</h1>
                    <div className="flex items-center gap-2">
                        <span className="h-1 w-4 bg-orange-500 rounded-full"></span>
                        <p className="text-[10px] font-bold tracking-[0.4em] text-slate-400 uppercase">Institutional Market Intelligence</p>
                    </div>
                </div>
            </div>
            <div className="text-right">
                <div className="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-1">MARKET TERMINAL</div>
                <div className="text-3xl font-black tracking-tight mb-1">{data.date}</div>
                <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Snapshot Generated @ {currentTime}</div>
            </div>
        </div>
      </div>

      {/* Main Indices Bar */}
      <div className="grid grid-cols-3 divide-x divide-slate-100 bg-slate-50 border-b border-slate-100">
        {[
          { label: 'NIFTY 50', val: data.indices.nifty50 },
          { label: 'SENSEX', val: data.indices.sensex },
          { label: 'NIFTY BANK', val: data.indices.niftyBank }
        ].map((index, i) => (
          <div key={i} className="p-8">
            <div className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2">{index.label}</div>
            <div className="text-3xl font-black text-slate-900 leading-none mb-3 tabular-nums">{index.val.value}</div>
            <div className={`flex items-center gap-2 font-bold text-sm ${index.val.isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
                <span className="text-lg">{index.val.isPositive ? '▲' : '▼'}</span>
                {index.val.change} <span className="text-[11px] opacity-70">({index.val.percentChange})</span>
            </div>
          </div>
        ))}
      </div>

      {/* Advanced Breadth Section */}
      <div className="grid grid-cols-2 border-b border-slate-100">
        <div className="p-10 border-r border-slate-100">
          <div className="flex items-center justify-between mb-10">
            <h4 className="font-black text-slate-800 text-[11px] uppercase tracking-widest">Market Breadth (NSE)</h4>
            <div className="flex gap-1">
                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500/30"></div>
            </div>
          </div>
          <div className="flex items-center gap-10">
            <div className="w-44 h-44 relative">
                <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                        <Pie data={adData} innerRadius={55} outerRadius={70} paddingAngle={8} dataKey="value" stroke="none">
                            {adData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                        </Pie>
                    </PieChart>
                </ResponsiveContainer>
                <div className="absolute inset-0 flex flex-col items-center justify-center">
                    <span className="text-2xl font-black text-slate-900">{data.advanceDecline.advancePercent}</span>
                    <span className="text-[8px] font-bold text-slate-400 uppercase tracking-widest mt-1">Advances</span>
                </div>
            </div>
            <div className="flex-1 space-y-4">
                <div className="p-4 rounded-2xl bg-emerald-50 border border-emerald-100">
                    <div className="text-[9px] font-black text-emerald-600 uppercase mb-1">Advances</div>
                    <div className="text-2xl font-black text-emerald-900 leading-none">{data.advanceDecline.advances}</div>
                </div>
                <div className="p-4 rounded-2xl bg-rose-50 border border-rose-100">
                    <div className="text-[9px] font-black text-rose-600 uppercase mb-1">Declines</div>
                    <div className="text-2xl font-black text-rose-900 leading-none">{data.advanceDecline.declines}</div>
                </div>
            </div>
          </div>
        </div>

        <div className="bg-slate-50 divide-y divide-slate-100">
          {[
            { label: 'Gold (MCX 10g)', data: data.commodities.gold, icon: 'fa-coins' },
            { label: 'Brent Crude ($)', data: data.commodities.oil, icon: 'fa-droplet' },
            { label: 'USD / INR', data: data.commodities.usdInr, icon: 'fa-dollar-sign' }
          ].map((c, i) => (
            <div key={i} className="px-10 py-7 flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center text-slate-400">
                  <i className={`fa-solid ${c.icon}`}></i>
                </div>
                <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">{c.label}</span>
              </div>
              <div className="text-right">
                <div className="font-black text-slate-900 text-xl tabular-nums">{c.data.value}</div>
                <div className={`text-[10px] font-bold ${c.data.isPositive ? 'text-emerald-600' : 'text-rose-600'}`}>
                  {c.data.isPositive ? '▲' : '▼'} {c.data.percentChange}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Stock Movers Grid */}
      <div className="grid grid-cols-2 divide-x divide-slate-100 flex-1 min-h-[400px]">
        <div className="p-10">
          <div className="flex items-center justify-between mb-6">
            <h4 className="font-black text-slate-800 text-[11px] uppercase tracking-widest border-l-4 border-emerald-500 pl-3">Top Gainers</h4>
            <span className="text-[9px] font-bold text-slate-400">NIFTY 50</span>
          </div>
          <div className="space-y-1">
            {data.gainers.slice(0, 5).map((s, i) => (
              <div key={i} className="flex items-center justify-between py-3.5 border-b border-slate-50 hover:bg-slate-50 rounded-lg px-2 transition-colors">
                <div className="font-black text-slate-800 text-sm tracking-tight">{s.company}</div>
                <div className="text-right">
                  <div className="text-xs font-bold text-slate-400 mb-0.5">{s.price}</div>
                  <div className="text-sm font-black text-emerald-600">+{s.percentChange}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div className="p-10">
          <div className="flex items-center justify-between mb-6">
            <h4 className="font-black text-slate-800 text-[11px] uppercase tracking-widest border-l-4 border-rose-500 pl-3">Top Losers</h4>
            <span className="text-[9px] font-bold text-slate-400">NIFTY 50</span>
          </div>
          <div className="space-y-1">
            {data.losers.slice(0, 5).map((s, i) => (
              <div key={i} className="flex items-center justify-between py-3.5 border-b border-slate-50 hover:bg-slate-50 rounded-lg px-2 transition-colors">
                <div className="font-black text-slate-800 text-sm tracking-tight">{s.company}</div>
                <div className="text-right">
                  <div className="text-xs font-bold text-slate-400 mb-0.5">{s.price}</div>
                  <div className="text-sm font-black text-rose-600">{s.percentChange}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* FII / DII Institutional Flow Section */}
      <div className="mx-10 mb-10 p-8 rounded-[2.5rem] bg-[#0f172a] text-white relative overflow-hidden">
          <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-32 -mt-32 blur-3xl"></div>
          <h4 className="font-black text-orange-500 text-[10px] uppercase tracking-[0.3em] mb-8 text-center">Institutional Net Cash Flow (₹ Cr)</h4>
          <div className="grid grid-cols-2 gap-12 relative z-10">
              <div className="text-center">
                  <div className="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">FII Activity</div>
                  <div className="grid grid-cols-2 gap-4">
                      <div className="bg-slate-800/50 p-4 rounded-2xl">
                          <div className="text-[8px] font-black text-slate-400 uppercase mb-1">Today</div>
                          <div className={`text-xl font-black ${data.fii.daily.net.includes('-') ? 'text-rose-400' : 'text-emerald-400'}`}>{data.fii.daily.net}</div>
                      </div>
                      <div className="bg-slate-800/50 p-4 rounded-2xl">
                          <div className="text-[8px] font-black text-slate-400 uppercase mb-1">MTD</div>
                          <div className={`text-xl font-black ${data.fii.mtd.net.includes('-') ? 'text-rose-400' : 'text-emerald-400'}`}>{data.fii.mtd.net}</div>
                      </div>
                  </div>
              </div>
              <div className="text-center">
                  <div className="text-[10px] font-black text-slate-500 uppercase mb-4 tracking-widest">DII Activity</div>
                  <div className="grid grid-cols-2 gap-4">
                      <div className="bg-slate-800/50 p-4 rounded-2xl">
                          <div className="text-[8px] font-black text-slate-400 uppercase mb-1">Today</div>
                          <div className={`text-xl font-black ${data.dii.daily.net.includes('-') ? 'text-rose-400' : 'text-emerald-400'}`}>{data.dii.daily.net}</div>
                      </div>
                      <div className="bg-slate-800/50 p-4 rounded-2xl">
                          <div className="text-[8px] font-black text-slate-400 uppercase mb-1">MTD</div>
                          <div className={`text-xl font-black ${data.dii.mtd.net.includes('-') ? 'text-rose-400' : 'text-emerald-400'}`}>{data.dii.mtd.net}</div>
                      </div>
                  </div>
              </div>
          </div>
      </div>

      {/* Verification Sources */}
      {data.sources && data.sources.length > 0 && (
          <div className="px-10 py-4 bg-slate-50/50 border-t border-slate-100">
              <p className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Verified Data Points:</p>
              <div className="flex flex-wrap gap-x-4 gap-y-1">
                  {data.sources.slice(0, 4).map((s, i) => (
                      <span key={i} className="text-[9px] text-blue-600/60 truncate max-w-[150px]">{s.title}</span>
                  ))}
              </div>
          </div>
      )}

      {/* Corporate Footer */}
      <div className="bg-slate-100 p-10 border-t border-slate-200 mt-auto">
          <div className="flex items-center justify-between mb-6">
            <div>
              <div className="text-slate-900 font-black text-xl tracking-tighter mb-1 uppercase">Vivek Financial Focus Ltd.</div>
              <p className="text-[9px] font-bold text-slate-500 uppercase tracking-widest">
                SEBI Reg: INZ000276333 | NSE & BSE Member | CDSL DP: 473-2020
              </p>
            </div>
            <div className="text-right">
                <div className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Portal</div>
                <div className="text-sm font-black text-slate-900">vivekfinancial.com</div>
            </div>
          </div>
          <p className="text-[9px] font-medium text-slate-400 text-center uppercase leading-relaxed max-w-2xl mx-auto italic">
            Disclaimer: Investments in stock markets are subject to market risks. This automated summary is for information only.
          </p>
      </div>
    </div>
  );
};

export default MarketSnapshotReport;